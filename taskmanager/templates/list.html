<html>
<head>
	<script language="JavaScript" src="/static/js/jquery-1.7.2.min.js"></script>
	<script language="JavaScript" src="/static/js/jquery-ui-1.8.22.custom.min.js"></script>	
	<link rel="stylesheet" type="text/css" href="/static/css/cupertino/jquery-ui-1.8.22.custom.css" />
	<style type="text/css">

	body,
	html {
		margin:0;
		padding:0;
		color:#000;
	}

    .sortable {
    	float:left;
    	width:600px;
	padding:3px;
    }
    #tagdiv {
   	float:left;
    	width:170px;
	list-style-type: none;
	border-style: dotted;
	border-width: 1px;
    }
    #tags {
	list-style-type: none;
    }

    ul {
	list-style-type: none;
    }
    .task_title {
	display:inline-block;
	width: 40%;
    }
    .icon-border {
        display: inline-block 
    }
</style>
<script>
	var itemOrder = jQuery.parseJSON('{{ itemOrder|safe }}');
	
	$.ajaxSetup ({
    	cache: false
	});

	
	$(function() {
		$("#newTaskPos").hide();
		$( ".sortable" ).sortable({
			placeholder: "ui-state-highlight",
			cancel: "input,textarea,button,select,option",
			connectWith: ".sortable",
			update: function(event, ui){
				var items = $(".sortable").sortable('toArray');
				var value = JSON.stringify(items);
				$.post("sort", {list: value}, function(data){
					var result = jQuery.parseJSON(data);
					for(var i in result){
						$("#" + i + "Priority").val(result[i]);
					}
				});
			}
		});
		// TODO: Load tag values
		var tagValues = ["asd", "asdf"];
		$('input[id$="AddTag"]').autocomplete({source: tagValues});
		$("[id$=AddTag]").hide();
	});

	function newTask(){
		$("#newTaskPos").show();
		
	}
	
	var beforeTitle = '<input type="checkbox" name="done[[id]]" onclick="completeTask([[id]])"/>';
	beforeTitle += ' &nbsp;<select id="item[id]Priority" onchange="changePriority([[id]], this)">{% for p in range(1,11) %}<option value="{{ p }}"{% if p == 1 %}selected="selected"{% endif %}>{{ p }}</option>{% endfor %}</select>&nbsp;';

	function saveNew(){
		var title = "" + $("#newTitle").val();
		$.post("newTask", {title: title, listId: {{ session['selected_list'] }} }, function(data){
			if(data > -1){
				 var insertBefore = beforeTitle.replace(/\[\[id\]\]/g,data);
				 $(".sortable").prepend("<li class='ui-state-default' id='item"+data+"'>"+insertBefore +title+"</li>");
			}
		});		
	}
	function completeTask(taskId){
		$.post("completeTask", {taskId: taskId}, function(data){
			// TODO: Callback, remove the item after some period
		});
	}
	function changePriority(taskId, selectBox){
		$.post("changePriority", {taskId: taskId, priorityIndex: selectBox.selectedIndex+1}, function(data){
			var key = "item" + taskId;
			var dataValue = Number(data);
			itemOrder[key] = dataValue;
			var prev = findPreviousId(dataValue);
			if(prev == null){
				var cur = $("#" + key).prev();
				while(cur.length > 0 && cur.prev().length > 0){
					cur = cur.prev();
				}
				$("#" + key).insertBefore(cur);
			} else {
				var prevElement = $("#" + prev);
				while(prevElement.next().length > 0 && itemOrder[prevElement.next().attr("id")] == itemOrder[prev]){
					prevElement = prevElement.next();
					prev = prevElement.attr("id");
				}
				$("#" + prev).after($("#" + key));
			}

		});		
	}
	function findPreviousId(value){
		var prev = null;
		for(var item in itemOrder){
			var nextValue = itemOrder[item];
			if(nextValue > value){
				if(prev == null || itemOrder[prev] > nextValue){
					prev = item;
				}
			}

		}
		return prev;
	}
	function changeList(){
		// TODO: Change List
	}
	
	function changeTag(tagId){
		// TODO: Change Tag
	}
	
	function addTag(taskId){
		var tags = $("#item" + taskId + "AddTag").val();
		if(tags.trim() == ""){
			return;
		}
		alert("adding " + tags);
		$.post("/addTag", {"taskId" : taskId, "tag": tags}, function(data) {
			alert(data);
		}).fail(function() { alert("Error adding tag") });
	}

	function tagBox(tagId){
		$("#item" + tagId + "AddTag").show();
	}
	function editTitle(tagId){
		// TODO
	}
</script>

</head>

<body>

<div class="list">
<div id="userName">Welcome {{ session['user'].name }}.</div>
<div id="lists"><select id="selectList" name="selectList" onchange="changeList()"
	class="ui-button ui-widget ui-state-default ui-corner-all">
		{% for list in lists %}
			<option value="{{ list.id }}"
				{% if list.id == selectedList %}
					selected="true"
				{% endif %}>{{ list.name }}</option>
		{% endfor %}
	
</select></div>
<div id="tagdiv" class="ui-widget-content">
	<ul id="tags">
	{% for tag in tags %}
		<li id="tag{{ tag.id }}"><a href="#" onclick="changeTag({{ tag.id }})">{{ tag.name }}</a></li>
	{% endfor %}
	</ul>
</div>
<div><a href="#" onclick="newTask()"><span class="icon-border"><span class="ui-icon ui-icon-circle-plus"></span></span> New Task</a></div>
<div id="newTaskPos">
	Title: <input type="text" name="newTitle"i id="newTitle" autocomplete="off">&nbsp;
	<input type="button" onclick="saveNew()" value="Save"></button>
</div>

<ul id="listitems1" class="sortable">
	{% for item in listItems %}
		<li class="ui-state-default ui-corner-all" id="item{{ item.id }}">
		<input type="checkbox" name="done{{ item.id }}" onclick="completeTask({{ item.id }})"/>
		<span id="sel"><select id="item{{ item.id }}Priority" onchange="changePriority({{ item.id }}, this)">
                        {% for p in range(1,11) %}
                                <option value="{{ p }}"
                                        {% if p == item.priority_index() %}
                                                selected="selected"
                                        {% endif %}>{{ p }}</option>
                        {% endfor %}
                </select></span>
		&nbsp;
		<div class="task_title">{{ item.title }}</div>
		&nbsp;
		<span class="ui-icon ui-icon-pencil" style="display:inline-block" onclick="editTitle('{{ item.id }}');"></span>
                <span id="item{{ item.id }}Tags" class="task_tags">
                        {% for tag in item.tags %}
                                {{ tag.name }} &nbsp;
                        {% endfor %}
			<input type="text" id="item{{ item.id }}AddTag" name="item{{ item.id }}AddTag" onchange="addTag({{ item.id }})" style="display:inline-block"/>
			<span class="ui-icon ui-icon-tag" style="display:inline-block" onclick="tagBox('{{ item.id }}');"></span>
                </span>
		</li>
	{% endfor %}
</ul>

</div>	
	
</body>	
	
</html>
